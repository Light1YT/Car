<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yellow Car Game</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Commissioner:wght@400;700&display=swap');
    
    body { 
      margin: 0; 
      overflow: hidden; 
      background: #222222;
      font-family: 'Commissioner', sans-serif;
    }
    canvas { 
      display: block; 
      background: transparent;
      box-shadow: 0 0 20px rgba(255, 238, 0, 0.3);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
</head>
<body>

<script>
// –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
class GameData {
  static save(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }
  
  static load(key, defaultValue = null) {
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : defaultValue;
  }
  
  static addDiamonds(amount) {
    const current = this.load('diamonds', 0);
    this.save('diamonds', current + amount);
  }
  
  static getDiamonds() {
    return this.load('diamonds', 1000); // –¢–µ—Å—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å 1000 –∞–ª–º–∞–∑–æ–≤
  }
  
  static spendDiamonds(amount) {
    const current = this.getDiamonds();
    if (current >= amount) {
      this.save('diamonds', current - amount);
      return true;
    }
    return false;
  }
  
  static saveScore(score) {
    const scores = this.load('scores', []);
    scores.push(Math.floor(score));
    scores.sort((a, b) => b - a);
    scores.splice(10); // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–ø-10
    this.save('scores', scores);
  }
  
  static getTopScores() {
    return this.load('scores', []);
  }
  
  static canClaimDailyReward() {
    const lastClaim = this.load('lastDailyReward', 0);
    const now = Date.now();
    const oneDay = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    return (now - lastClaim) >= oneDay;
  }
  
  static claimDailyReward() {
    if (this.canClaimDailyReward()) {
      this.addDiamonds(1);
      this.save('lastDailyReward', Date.now());
      return true;
    }
    return false;
  }
  
  static resetDiamonds() {
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å (–¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫–µ—à–µ–º)
    this.save('diamonds', 1000);
  }
}

// –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
class MenuScene extends Phaser.Scene {
  constructor() {
    super('MenuScene');
  }

  create() {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;

    // –§–æ–Ω
    this.add.rectangle(gameWidth / 2, gameHeight / 2, gameWidth, gameHeight, 0x222222);

    // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    this.createAnimatedBackground();

    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –º–µ–Ω—é –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.events.on('wake', () => {
      this.updateDiamondsDisplay();
    });
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫–µ—à–µ–º
    GameData.resetDiamonds();

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏
    this.add.text(gameWidth / 2, gameHeight * 0.12, '–ê–í–¢–û–°–ï–†–í–ò–°', {
      font: 'bold 32px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 2
    }).setOrigin(0.5);

    this.add.text(gameWidth / 2, gameHeight * 0.17, '–ö–û–†–ï–ê–ù–ê', {
      font: 'bold 32px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 2
    }).setOrigin(0.5);

    // –ë–∞–ª–∞–Ω—Å –∞–ª–º–∞–∑–æ–≤ (—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º)
    const diamonds = GameData.getDiamonds();
    this.diamondsText = this.add.text(gameWidth / 2, gameHeight * 0.25, `üíé ${diamonds}`, {
      font: 'bold 24px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    }).setOrigin(0.5);

    // –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
    const buttonStyle = {
      font: 'bold 20px Commissioner',
      fill: '#222222',
      backgroundColor: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    };

    const playButton = this.createButton(gameWidth / 2, gameHeight * 0.38, '–ò–ì–†–ê–¢–¨', buttonStyle, () => {
      this.scene.start('MainScene');
    });

    const shopButton = this.createButton(gameWidth / 2, gameHeight * 0.48, '–ú–ê–ì–ê–ó–ò–ù', buttonStyle, () => {
      this.scene.start('ShopScene');
    });

    const promoButton = this.createButton(gameWidth / 2, gameHeight * 0.58, '–ê–ö–¶–ò–ò', buttonStyle, () => {
      this.scene.start('PromotionsScene');
    });

    const leaderButton = this.createButton(gameWidth / 2, gameHeight * 0.68, '–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í', buttonStyle, () => {
      this.scene.start('LeaderboardScene');
    });
  }

  createButton(x, y, text, style, callback) {
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω –∫–Ω–æ–ø–∫–∏ —Å–æ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è–º–∏
    const buttonBg = this.add.graphics();
    buttonBg.fillStyle(0xFFEE00);
    buttonBg.fillRoundedRect(x - 120, y - 25, 240, 50, 15);
    buttonBg.lineStyle(2, 0x222222);
    buttonBg.strokeRoundedRect(x - 120, y - 25, 240, 50, 15);

    // –ù–µ–≤–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è –∫–ª–∏–∫–∞ (–±–æ–ª—å—à–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏)
    const clickArea = this.add.rectangle(x, y, 260, 70, 0x000000, 0);
    clickArea.setInteractive();

    const button = this.add.text(x, y, text, style)
      .setOrigin(0.5);

    clickArea
      .on('pointerdown', callback)
      .on('pointerover', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0xC8C8C8);
        buttonBg.fillRoundedRect(x - 120, y - 25, 240, 50, 15);
        buttonBg.lineStyle(2, 0xFFEE00);
        buttonBg.strokeRoundedRect(x - 120, y - 25, 240, 50, 15);
        button.setFill('#FFEE00');
      })
      .on('pointerout', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0xFFEE00);
        buttonBg.fillRoundedRect(x - 120, y - 25, 240, 50, 15);
        buttonBg.lineStyle(2, 0x222222);
        buttonBg.strokeRoundedRect(x - 120, y - 25, 240, 50, 15);
        button.setFill('#222222');
      });
    return button;
  }

  createAnimatedBackground() {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;

    // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–≤–∏–∂—É—â–∏—Ö—Å—è –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–≥—É—Ä –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —Å—Ç–∏–ª–µ
    for (let i = 0; i < 6; i++) {
      const shape = this.add.graphics();
      const size = Phaser.Math.Between(20, 60);
      const x = Phaser.Math.Between(0, gameWidth);
      const y = Phaser.Math.Between(0, gameHeight);
      
      // –†–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–∏–≥—É—Ä—ã –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ü–≤–µ—Ç–∞—Ö
      if (i % 3 === 0) {
        // –ñ—ë–ª—Ç—ã–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏
        shape.fillStyle(0xFFEE00, 0.1);
        shape.fillRoundedRect(-size/2, -size/2, size, size, 8);
      } else if (i % 3 === 1) {
        // –°–µ—Ä—ã–µ –∫—Ä—É–≥–∏
        shape.fillStyle(0xC8C8C8, 0.08);
        shape.fillCircle(0, 0, size/2);
      } else {
        // –ñ—ë–ª—Ç—ã–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏
        shape.fillStyle(0xFFEE00, 0.06);
        shape.fillTriangle(-size/2, size/2, 0, -size/2, size/2, size/2);
      }
      
      shape.setPosition(x, y);
      
      // –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
      this.tweens.add({
        targets: shape,
        x: x + Phaser.Math.Between(-100, 100),
        y: y + Phaser.Math.Between(-100, 100),
        rotation: Math.PI * 2,
        duration: Phaser.Math.Between(8000, 15000),
        yoyo: true,
        repeat: -1,
        ease: 'Sine.easeInOut'
      });
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–µ –ª–∏–Ω–∏–∏ –≤ —Å—Ç–∏–ª–µ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞
    for (let i = 0; i < 3; i++) {
      const line = this.add.graphics();
      line.lineStyle(2, 0xFFEE00, 0.3);
      const startX = Phaser.Math.Between(0, gameWidth);
      const startY = Phaser.Math.Between(0, gameHeight);
      const endX = Phaser.Math.Between(0, gameWidth);
      const endY = Phaser.Math.Between(0, gameHeight);
      
      line.lineBetween(startX, startY, endX, endY);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
      this.tweens.add({
        targets: line,
        alpha: 0.1,
        duration: Phaser.Math.Between(3000, 6000),
        yoyo: true,
        repeat: -1,
        ease: 'Sine.easeInOut'
      });
    }
  }

  updateDiamondsDisplay() {
    const diamonds = GameData.getDiamonds();
    this.diamondsText.setText(`üíé ${diamonds}`);
    this.diamondsText.setStyle({
      font: 'bold 24px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    });
  }
}

// –ú–∞–≥–∞–∑–∏–Ω
class ShopScene extends Phaser.Scene {
  constructor() {
    super('ShopScene');
  }

  create() {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;

    // –§–æ–Ω
    this.add.rectangle(gameWidth / 2, gameHeight / 2, gameWidth, gameHeight, 0x222222);

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    this.add.text(gameWidth / 2, gameHeight * 0.08, '–ú–ê–ì–ê–ó–ò–ù –ó–ê–ü–ß–ê–°–¢–ï–ô', {
      font: 'bold 32px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 2
    }).setOrigin(0.5);

    // –ë–∞–ª–∞–Ω—Å
    const diamonds = GameData.getDiamonds();
    this.diamondsText = this.add.text(gameWidth / 2, gameHeight * 0.15, `–ë–∞–ª–∞–Ω—Å: üíé ${diamonds}`, {
      font: 'bold 22px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    }).setOrigin(0.5);

    // –¢–æ–≤–∞—Ä—ã
    const items = [
      { name: '–°–∫–∏–¥–∫–∞ 10%', price: 15, description: '–°–∫–∏–¥–∫–∞ –Ω–∞ –≤—Å–µ –ø–æ–∫—É–ø–∫–∏' },
      { name: '–°–∫–∏–¥–∫–∞ 15%', price: 25, description: '–£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞' },
      { name: '–°–∫–∏–¥–∫–∞ 20%', price: 50, description: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞' },
      { name: '–ë—É–¥–∏–ª—å–Ω–∏–∫', price: 15, description: '–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç' }
    ];

    items.forEach((item, index) => {
      const y = gameHeight * 0.25 + index * (gameHeight * 0.1);
      this.createShopItem(gameWidth / 2, y, item);
    });

    // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    this.createBackButton(gameWidth * 0.15, gameHeight * 0.9, '–ù–ê–ó–ê–î', () => {
      this.scene.start('MenuScene');
    });
  }

  createShopButton(x, y, text, callback) {
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω –∫–Ω–æ–ø–∫–∏ —Å–æ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è–º–∏
    const buttonBg = this.add.graphics();
    buttonBg.fillStyle(0xFFEE00);
    buttonBg.fillRoundedRect(x - 40, y - 15, 80, 30, 12);
    buttonBg.lineStyle(2, 0x222222);
    buttonBg.strokeRoundedRect(x - 40, y - 15, 80, 30, 12);

    const button = this.add.text(x, y, text, {
      font: 'bold 12px Commissioner',
      fill: '#222222'
    })
      .setOrigin(0.5)
      .setInteractive()
      .on('pointerdown', callback)
      .on('pointerover', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0x222222);
        buttonBg.fillRoundedRect(x - 40, y - 15, 80, 30, 12);
        buttonBg.lineStyle(2, 0xFFEE00);
        buttonBg.strokeRoundedRect(x - 40, y - 15, 80, 30, 12);
        button.setFill('#FFEE00');
      })
      .on('pointerout', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0xFFEE00);
        buttonBg.fillRoundedRect(x - 40, y - 15, 80, 30, 12);
        buttonBg.lineStyle(2, 0x222222);
        buttonBg.strokeRoundedRect(x - 40, y - 15, 80, 30, 12);
        button.setFill('#222222');
      });
    return button;
  }

  createBackButton(x, y, text, callback) {
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω –∫–Ω–æ–ø–∫–∏ —Å–æ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è–º–∏
    const buttonBg = this.add.graphics();
    buttonBg.fillStyle(0x222222);
    buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
    buttonBg.lineStyle(2, 0xC8C8C8);
    buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);

    const button = this.add.text(x, y, text, {
      font: 'bold 16px Commissioner',
      fill: '#C8C8C8'
    })
      .setOrigin(0.5)
      .setInteractive()
      .on('pointerdown', callback)
      .on('pointerover', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0xC8C8C8);
        buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
        buttonBg.lineStyle(2, 0x222222);
        buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);
        button.setFill('#222222');
      })
      .on('pointerout', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0x222222);
        buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
        buttonBg.lineStyle(2, 0xC8C8C8);
        buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);
        button.setFill('#C8C8C8');
      });
    return button;
  }

  createShopItem(x, y, item) {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;
    
    // –§–æ–Ω —Ç–æ–≤–∞—Ä–∞
    const itemBg = this.add.graphics();
    itemBg.fillStyle(0xC8C8C8, 0.2);
    itemBg.fillRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 12);
    itemBg.lineStyle(2, 0xC8C8C8);
    itemBg.strokeRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 12);

    // –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    this.add.text(x - gameWidth * 0.35, y - gameHeight * 0.012, item.name, {
      font: 'bold 16px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    }).setOrigin(0, 0.5);

    // –û–ø–∏—Å–∞–Ω–∏–µ
    this.add.text(x - gameWidth * 0.35, y + gameHeight * 0.012, item.description, {
      font: '12px Commissioner',
      fill: '#FFFFFF'
    }).setOrigin(0, 0.5);

    // –¶–µ–Ω–∞ (—Å–º–µ—â–µ–Ω–∞ –ª–µ–≤–µ–µ –æ—Ç –∫–Ω–æ–ø–∫–∏)
    this.add.text(x + gameWidth * 0.08, y - gameHeight * 0.008, `üíé ${item.price}`, {
      font: 'bold 14px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    }).setOrigin(0.5, 0.5);

    // –ö–Ω–æ–ø–∫–∞ –∫—É–ø–∏—Ç—å (—Å–º–µ—â–µ–Ω–∞ –¥–∞–ª—å—à–µ –≤–ø—Ä–∞–≤–æ)
    const buyButton = this.createShopButton(x + gameWidth * 0.32, y + gameHeight * 0.012, '–ö–£–ü–ò–¢–¨', () => {
      this.buyItem(item);
    });
  }

  buyItem(item) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–æ–≤–∞—Ä —Å–∫–∏–¥–∫–æ–π
    if (item.name.includes('–°–∫–∏–¥–∫–∞')) {
      this.showDiscountWarning(item);
    } else {
      if (GameData.spendDiamonds(item.price)) {
        this.showPurchaseConfirmation(item);
        this.updateDiamondsDisplay();
      } else {
        this.showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤!');
      }
    }
  }

  showDiscountWarning(item) {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;

    // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
    const overlay = this.add.rectangle(gameWidth / 2, gameHeight / 2, gameWidth, gameHeight, 0x000000, 0.7);

    // –û–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (—É–≤–µ–ª–∏—á–µ–Ω–æ –ø–æ –≤—ã—Å–æ—Ç–µ –¥–ª—è –¥–≤—É—Ö —Ä—è–¥–æ–≤ –∫–Ω–æ–ø–æ–∫)
    const warningBox = this.add.rectangle(gameWidth / 2, gameHeight / 2, gameWidth * 0.85, gameHeight * 0.6, 0x333333);
    warningBox.setStrokeStyle(3, 0xFFFF00);

    const titleText = this.add.text(gameWidth / 2, gameHeight / 2 - gameHeight * 0.2, '–í–ù–ò–ú–ê–ù–ò–ï!', {
      font: 'bold 24px Arial',
      fill: '#FFFF00',
      stroke: '#000',
      strokeThickness: 2
    }).setOrigin(0.5);

    const warningText = this.add.text(gameWidth / 2, gameHeight / 2 - gameHeight * 0.08, 
      '–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –≤—ã –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å\n–Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º—É –∑–∞–ø–∏—Å–∏.\n\n–¢–û–õ–¨–ö–û –ü–û –ù–ï–ô –í–´ –°–ú–û–ñ–ï–¢–ï\n–ü–û–õ–£–ß–ò–¢–¨ –°–ö–ò–î–ö–£!', {
      font: 'bold 16px Arial',
      fill: '#fff',
      stroke: '#000',
      strokeThickness: 1,
      align: 'center'
    }).setOrigin(0.5);

    const continueButton = this.createButton(gameWidth / 2, gameHeight / 2 + gameHeight * 0.08, '–ü–†–û–î–û–õ–ñ–ò–¢–¨', {
      font: 'bold 16px Arial',
      fill: '#fff',
      backgroundColor: '#00aa00',
      stroke: '#000',
      strokeThickness: 2
    }, () => {
      if (GameData.spendDiamonds(item.price)) {
        this.destroyWarningDialog(overlay, warningBox, titleText, warningText, continueButton, cancelButton);
        this.showPurchaseConfirmation(item);
        this.updateDiamondsDisplay();
      } else {
        this.destroyWarningDialog(overlay, warningBox, titleText, warningText, continueButton, cancelButton);
        this.showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤!');
      }
    });

    const cancelButton = this.createButton(gameWidth / 2, gameHeight / 2 + gameHeight * 0.16, '–û–¢–ú–ï–ù–ê', {
      font: 'bold 16px Arial',
      fill: '#fff',
      backgroundColor: '#aa0000',
      stroke: '#000',
      strokeThickness: 2
    }, () => {
      this.destroyWarningDialog(overlay, warningBox, titleText, warningText, continueButton, cancelButton);
    });
  }

  destroyWarningDialog(overlay, warningBox, titleText, warningText, continueButton, cancelButton) {
    overlay.destroy();
    warningBox.destroy();
    titleText.destroy();
    warningText.destroy();
    continueButton.destroy();
    cancelButton.destroy();
  }

  showPurchaseConfirmation(item) {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;

    // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
    const overlay = this.add.rectangle(gameWidth / 2, gameHeight / 2, gameWidth, gameHeight, 0x000000, 0.7);

    // –û–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—É–≤–µ–ª–∏—á–µ–Ω–æ –ø–æ –≤—ã—Å–æ—Ç–µ –¥–ª—è –¥–≤—É—Ö —Ä—è–¥–æ–≤ –∫–Ω–æ–ø–æ–∫)
    const confirmBox = this.add.rectangle(gameWidth / 2, gameHeight / 2, 400, 320, 0x333333);
    confirmBox.setStrokeStyle(3, 0xFFFFFF);

    const titleText = this.add.text(gameWidth / 2, gameHeight / 2 - 60, '–ü–û–ö–£–ü–ö–ê –°–û–í–ï–†–®–ï–ù–ê!', {
      font: 'bold 24px Arial',
      fill: '#00ff00',
      stroke: '#000',
      strokeThickness: 2
    }).setOrigin(0.5);

    const itemText = this.add.text(gameWidth / 2, gameHeight / 2 - 20, `${item.name} –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω!`, {
      font: '18px Arial',
      fill: '#fff'
    }).setOrigin(0.5);

    const questionText = this.add.text(gameWidth / 2, gameHeight / 2 + 10, '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç?', {
      font: '16px Arial',
      fill: '#ccc'
    }).setOrigin(0.5);

    const yesButton = this.createButton(gameWidth / 2, gameHeight / 2 + 40, '–î–ê', {
      font: 'bold 20px Arial',
      fill: '#fff',
      backgroundColor: '#00aa00',
      stroke: '#000',
      strokeThickness: 2
    }, () => {
      this.openLink('https://koreanaparts.ru/block/119');
      this.destroyConfirmDialog(overlay, confirmBox, titleText, itemText, questionText, yesButton, noButton);
    });

    const noButton = this.createButton(gameWidth / 2, gameHeight / 2 + 100, '–ù–ï–¢', {
      font: 'bold 20px Arial',
      fill: '#fff',
      backgroundColor: '#aa0000',
      stroke: '#000',
      strokeThickness: 2
    }, () => {
      this.destroyConfirmDialog(overlay, confirmBox, titleText, itemText, questionText, yesButton, noButton);
    });
  }

  destroyConfirmDialog(overlay, confirmBox, titleText, itemText, questionText, yesButton, noButton) {
    overlay.destroy();
    confirmBox.destroy();
    titleText.destroy();
    itemText.destroy();
    questionText.destroy();
    yesButton.destroy();
    noButton.destroy();
  }

  openLink(url) {
    // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º location.href
    if (this.sys.game.device.os.iOS || this.sys.game.device.os.android) {
      location.href = url;
    } else {
      window.open(url, '_blank');
    }
  }

  showMessage(text) {
    const gameHeight = this.sys.game.config.height;
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const messageBg = this.add.graphics();
    messageBg.fillStyle(0x222222, 0.9);
    messageBg.fillRoundedRect(this.sys.game.config.width / 2 - 150, gameHeight * 0.85 - 25, 300, 50, 15);
    messageBg.lineStyle(2, 0xFFEE00);
    messageBg.strokeRoundedRect(this.sys.game.config.width / 2 - 150, gameHeight * 0.85 - 25, 300, 50, 15);
    
    const message = this.add.text(this.sys.game.config.width / 2, gameHeight * 0.85, text, {
      font: 'bold 16px Commissioner',
      fill: '#FFEE00',
      align: 'center'
    }).setOrigin(0.5);

    this.time.delayedCall(2000, () => {
      message.destroy();
      messageBg.destroy();
    });
  }

  updateDiamondsDisplay() {
    const diamonds = GameData.getDiamonds();
    this.diamondsText.setText(`–ë–∞–ª–∞–Ω—Å: üíé ${diamonds}`);
    this.diamondsText.setStyle({
      font: 'bold 22px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    });
  }

  createButton(x, y, text, style, callback) {
    const button = this.add.text(x, y, text, style)
      .setOrigin(0.5)
      .setPadding(15, 10)
      .setInteractive()
      .on('pointerdown', callback)
      .on('pointerover', () => {
        button.setScale(1.1);
      })
      .on('pointerout', () => {
        button.setScale(1);
      });
    return button;
  }
}

// –ê–∫—Ü–∏–∏
class PromotionsScene extends Phaser.Scene {
  constructor() {
    super('PromotionsScene');
  }

  create() {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;

    // –§–æ–Ω
    this.add.rectangle(gameWidth / 2, gameHeight / 2, gameWidth, gameHeight, 0x222222);

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    this.add.text(gameWidth / 2, gameHeight * 0.08, '–ê–ö–¶–ò–ò –ò –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø', {
      font: 'bold 30px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 2
    }).setOrigin(0.5);

    // –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞
    this.createDailyReward(gameWidth / 2, gameHeight * 0.22);
    
    // –î–≤–æ–π–Ω—ã–µ –∞–ª–º–∞–∑—ã –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ
    this.createPromotion(gameWidth / 2, gameHeight * 0.35, '–î–≤–æ–π–Ω—ã–µ –∞–ª–º–∞–∑—ã –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ!', null);
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏
    this.createPromotion(gameWidth / 2, gameHeight * 0.48, '–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏', () => {
      this.openLink('https://koreanaparts.ru/specpredlozheniya-i-akcii-kompanii-koreana-sankt-peterburg');
    });
    
    // –ú–µ–º –∑–∞ –∞–ª–º–∞–∑
    this.createPromotion(gameWidth / 2, gameHeight * 0.61, '–ú–µ–º –∑–∞ –∞–ª–º–∞–∑', () => {
      this.openLink('https://www.anekdot.ru/last/mem/');
    });

    // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    this.createBackButton(gameWidth * 0.15, gameHeight * 0.9, '–ù–ê–ó–ê–î', () => {
      this.scene.start('MenuScene');
    });
  }

  createBackButton(x, y, text, callback) {
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω –∫–Ω–æ–ø–∫–∏ —Å–æ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è–º–∏
    const buttonBg = this.add.graphics();
    buttonBg.fillStyle(0x222222);
    buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
    buttonBg.lineStyle(2, 0xC8C8C8);
    buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);

    const button = this.add.text(x, y, text, {
      font: 'bold 16px Commissioner',
      fill: '#C8C8C8'
    })
      .setOrigin(0.5)
      .setInteractive()
      .on('pointerdown', callback)
      .on('pointerover', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0xC8C8C8);
        buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
        buttonBg.lineStyle(2, 0x222222);
        buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);
        button.setFill('#222222');
      })
      .on('pointerout', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0x222222);
        buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
        buttonBg.lineStyle(2, 0xC8C8C8);
        buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);
        button.setFill('#C8C8C8');
      });
    return button;
  }

  createDailyReward(x, y) {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;
    const canClaim = GameData.canClaimDailyReward();
    
    const promoBg = this.add.graphics();
    const bgColor = canClaim ? 0xFFEE00 : 0xC8C8C8;
    const strokeColor = canClaim ? 0x222222 : 0x666666;
    promoBg.fillStyle(bgColor, 0.9);
    promoBg.fillRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);
    promoBg.lineStyle(2, strokeColor);
    promoBg.strokeRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);

    const text = canClaim ? '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ +1 –∞–ª–º–∞–∑ (–î–æ—Å—Ç—É–ø–Ω–æ!)' : '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ +1 –∞–ª–º–∞–∑ (–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ)';
    const color = canClaim ? '#222222' : '#666666';
    
    const rewardText = this.add.text(x, y, text, {
      font: 'bold 14px Commissioner',
      fill: color
    }).setOrigin(0.5);

    if (canClaim) {
      rewardText.setInteractive()
        .on('pointerdown', () => {
          if (GameData.claimDailyReward()) {
            this.showMessage('–ü–æ–ª—É—á–µ–Ω 1 –∞–ª–º–∞–∑! –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞!');
            rewardText.setText('–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ +1 –∞–ª–º–∞–∑ (–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ)');
            rewardText.setFill('#666666');
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ñ–æ–Ω
            promoBg.clear();
            promoBg.fillStyle(0xC8C8C8, 0.9);
            promoBg.fillRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);
            promoBg.lineStyle(2, 0x666666);
            promoBg.strokeRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);
            rewardText.removeInteractive();
          }
        })
        .on('pointerover', () => {
          rewardText.setScale(1.05);
        })
        .on('pointerout', () => {
          rewardText.setScale(1);
        });
    }
  }

  createPromotion(x, y, text, callback) {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;
    
    const promoBg = this.add.graphics();
    const bgColor = callback ? 0x222222 : 0xC8C8C8;
    const strokeColor = callback ? 0xFFEE00 : 0x222222;
    promoBg.fillStyle(bgColor, 0.9);
    promoBg.fillRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);
    promoBg.lineStyle(2, strokeColor);
    promoBg.strokeRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);

    const promoText = this.add.text(x, y, text, {
      font: 'bold 14px Commissioner',
      fill: callback ? '#FFEE00' : '#222222'
    }).setOrigin(0.5);

    if (callback) {
      promoText.setInteractive()
        .on('pointerdown', callback)
        .on('pointerover', () => {
          promoText.setScale(1.05);
          // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è - –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞
          promoBg.clear();
          promoBg.fillStyle(0xFFEE00, 0.9);
          promoBg.fillRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);
          promoBg.lineStyle(2, 0x222222);
          promoBg.strokeRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);
          promoText.setFill('#222222');
        })
        .on('pointerout', () => {
          promoText.setScale(1);
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
          promoBg.clear();
          promoBg.fillStyle(0x222222, 0.9);
          promoBg.fillRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);
          promoBg.lineStyle(2, 0xFFEE00);
          promoBg.strokeRoundedRect(x - gameWidth * 0.42, y - gameHeight * 0.03, gameWidth * 0.84, gameHeight * 0.06, 15);
          promoText.setFill('#FFEE00');
        });
    }
  }

  showMessage(text) {
    const gameHeight = this.sys.game.config.height;
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const messageBg = this.add.graphics();
    messageBg.fillStyle(0x222222, 0.9);
    messageBg.fillRoundedRect(this.sys.game.config.width / 2 - 150, gameHeight * 0.85 - 25, 300, 50, 15);
    messageBg.lineStyle(2, 0xFFEE00);
    messageBg.strokeRoundedRect(this.sys.game.config.width / 2 - 150, gameHeight * 0.85 - 25, 300, 50, 15);
    
    const message = this.add.text(this.sys.game.config.width / 2, gameHeight * 0.85, text, {
      font: 'bold 16px Commissioner',
      fill: '#FFEE00',
      align: 'center'
    }).setOrigin(0.5);

    this.time.delayedCall(3000, () => {
      message.destroy();
      messageBg.destroy();
    });
  }

  openLink(url) {
    // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º location.href
    if (this.sys.game.device.os.iOS || this.sys.game.device.os.android) {
      location.href = url;
    } else {
      window.open(url, '_blank');
    }
  }

  createButton(x, y, text, style, callback) {
    const button = this.add.text(x, y, text, style)
      .setOrigin(0.5)
      .setPadding(15, 10)
      .setInteractive()
      .on('pointerdown', callback)
      .on('pointerover', () => {
        button.setScale(1.1);
      })
      .on('pointerout', () => {
        button.setScale(1);
      });
    return button;
  }
}

// –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
class LeaderboardScene extends Phaser.Scene {
  constructor() {
    super('LeaderboardScene');
  }

  create() {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;

    // –§–æ–Ω
    this.add.rectangle(gameWidth / 2, gameHeight / 2, gameWidth, gameHeight, 0x222222);

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    this.add.text(gameWidth / 2, gameHeight * 0.08, '–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í', {
      font: 'bold 28px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 2
    }).setOrigin(0.5);

    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ—Ä–¥—ã
    const scores = GameData.getTopScores();

    if (scores.length === 0) {
      this.add.text(gameWidth / 2, gameHeight * 0.4, '–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤', {
        font: 'bold 20px Commissioner',
        fill: '#C8C8C8'
      }).setOrigin(0.5);
    } else {
      scores.forEach((score, index) => {
        const y = gameHeight * 0.22 + index * (gameHeight * 0.045);
        const medal = index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `${index + 1}.`;
        
        this.add.text(gameWidth / 2, y, `${medal} ${score} –æ—á–∫–æ–≤`, {
          font: 'bold 16px Commissioner',
          fill: '#FFEE00',
          stroke: '#222222',
          strokeThickness: 1
        }).setOrigin(0.5);
      });
    }

    // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    this.createBackButton(gameWidth * 0.15, gameHeight * 0.9, '–ù–ê–ó–ê–î', () => {
      this.scene.start('MenuScene');
    });
  }

  createBackButton(x, y, text, callback) {
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω –∫–Ω–æ–ø–∫–∏ —Å–æ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è–º–∏
    const buttonBg = this.add.graphics();
    buttonBg.fillStyle(0x222222);
    buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
    buttonBg.lineStyle(2, 0xC8C8C8);
    buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);

    const button = this.add.text(x, y, text, {
      font: 'bold 16px Commissioner',
      fill: '#C8C8C8'
    })
      .setOrigin(0.5)
      .setInteractive()
      .on('pointerdown', callback)
      .on('pointerover', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0xC8C8C8);
        buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
        buttonBg.lineStyle(2, 0x222222);
        buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);
        button.setFill('#222222');
      })
      .on('pointerout', () => {
        buttonBg.clear();
        buttonBg.fillStyle(0x222222);
        buttonBg.fillRoundedRect(x - 50, y - 20, 100, 40, 15);
        buttonBg.lineStyle(2, 0xC8C8C8);
        buttonBg.strokeRoundedRect(x - 50, y - 20, 100, 40, 15);
        button.setFill('#C8C8C8');
      });
    return button;
  }

  createButton(x, y, text, style, callback) {
    const button = this.add.text(x, y, text, style)
      .setOrigin(0.5)
      .setPadding(15, 10)
      .setInteractive()
      .on('pointerdown', callback)
      .on('pointerover', () => {
        button.setScale(1.1);
      })
      .on('pointerout', () => {
        button.setScale(1);
      });
    return button;
  }
}

// –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–∞ (–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
class MainScene extends Phaser.Scene {
  constructor() {
    super('MainScene');
    this.gameOverFlag = false;
    this.touchStartX = 0;
    this.touchStartY = 0;
    this.isTouching = false;
  }

  preload() {
    this.load.image('car', 'car.png');
    this.load.image('bonus', 'bonus.png');
    this.load.image('obstacle', 'obstacle.png');
  }

  create() {
    this.laneCount = 3;
    this.speed = 200;
    this.score = 0;
    this.nextSpeedUp = 0;
    this.lastObstacleSpawnTime = 0;
    this.lastDiamondSpawnTime = 0;
    this.gameOverFlag = false;

    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;
    this.laneWidth = gameWidth / this.laneCount;

    // –°–æ–∑–¥–∞–µ–º –¥–æ—Ä–æ–≥—É –∏ —Ñ–æ–Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    this.createRoad();
    this.createBackgroundElements();

    this.player = this.physics.add.sprite(gameWidth / 2, gameHeight * 0.8, 'car');
    this.player.setDisplaySize(gameWidth * 0.2, gameHeight * 0.09);
    this.player.setCollideWorldBounds(true);
    this.player.lane = 1;

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–Ω—å –¥–ª—è –º–∞—à–∏–Ω–∫–∏
    this.playerShadow = this.add.ellipse(this.player.x, this.player.y + 30, gameWidth * 0.18, gameHeight * 0.03, 0x000000, 0.4);

    this.obstacles = this.physics.add.group();
    this.bonuses = this.physics.add.group();
    this.extraBonuses = this.physics.add.group(); // –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ –¥–ª—è –∞–ª–º–∞–∑–æ–≤

    this.physics.add.overlap(this.player, this.obstacles, () => this.handleGameOver(), null, this);
    this.physics.add.overlap(this.player, this.bonuses, (player, bonus) => {
      bonus.destroy();
      this.score += 50;
      this.createScoreEffect(bonus.x, bonus.y, '+50');
    }, null, this);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±–æ—Ä–∞ –∞–ª–º–∞–∑–æ–≤
    this.physics.add.overlap(this.player, this.extraBonuses, (player, diamond) => {
      diamond.destroy();
      GameData.addDiamonds(1);
      this.createScoreEffect(diamond.x, diamond.y, '+1üíé');
      this.updateDiamondsDisplay();
    }, null, this);

    // –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—á–µ—Ç
    this.scoreText = this.add.text(20, 20, '–°–ß–ï–¢: 0', { 
      font: 'bold 24px Commissioner', 
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 2
    });

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–ª–º–∞–∑–æ–≤
    this.diamondsText = this.add.text(20, 60, `üíé ${GameData.getDiamonds()}`, {
      font: 'bold 20px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    });

    this.input.keyboard.on('keydown-LEFT', () => this.changeLane(-1));
    this.input.keyboard.on('keydown-RIGHT', () => this.changeLane(1));
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞–º–∏
    this.input.on('pointerdown', (pointer) => {
      this.touchStartX = pointer.x;
      this.touchStartY = pointer.y;
      this.isTouching = true;
    });
    
    this.input.on('pointerup', (pointer) => {
      if (this.isTouching) {
        this.handleSwipe(pointer.x, pointer.y);
        this.isTouching = false;
      }
    });
    
    this.input.on('pointermove', (pointer) => {
      if (this.isTouching) {
        const deltaX = pointer.x - this.touchStartX;
        const deltaY = pointer.y - this.touchStartY;
        
        if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
          if (deltaX > 0) {
            this.changeLane(1);
          } else {
            this.changeLane(-1);
          }
          this.isTouching = false;
        }
      }
    });
  }

  createRoad() {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;
    
    // –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ—Ä–æ–≥–∞ (–∞—Å—Ñ–∞–ª—å—Ç)
    this.add.rectangle(gameWidth / 2, gameHeight / 2, gameWidth, gameHeight, 0x2c2c2c);
    
    // –û–±–æ—á–∏–Ω—ã —Å —Ç—Ä–∞–≤–æ–π
    const shoulderWidth = gameWidth * 0.15;
    this.add.rectangle(shoulderWidth / 2, gameHeight / 2, shoulderWidth, gameHeight, 0x228B22);
    this.add.rectangle(gameWidth - shoulderWidth / 2, gameHeight / 2, shoulderWidth, gameHeight, 0x228B22);
    
    // –ë–æ–∫–æ–≤—ã–µ –æ–≥—Ä–∞–∂–¥–µ–Ω–∏—è
    this.add.rectangle(shoulderWidth, gameHeight / 2, 8, gameHeight, 0xFFFFFF);
    this.add.rectangle(gameWidth - shoulderWidth, gameHeight / 2, 8, gameHeight, 0xFFFFFF);
    
    // –†–∞–∑–º–µ—Ç–∫–∞ –ø–æ–ª–æ—Å –¥–≤–∏–∂–µ–Ω–∏—è
    const roadWidth = gameWidth - (shoulderWidth * 2);
    const roadStart = shoulderWidth;
    const laneWidth = roadWidth / this.laneCount;
    
    // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É –ø–æ–ª–æ—Å–∞–º–∏
    for (let i = 1; i < this.laneCount; i++) {
      const x = roadStart + i * laneWidth;
      for (let y = 0; y < gameHeight; y += 60) {
        this.add.rectangle(x, y, 4, 30, 0xFFFF00);
      }
    }
    
    // –ë–æ–∫–æ–≤—ã–µ –ø—É–Ω–∫—Ç–∏—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏
    for (let y = 0; y < gameHeight; y += 40) {
      this.add.rectangle(roadStart + 20, y, 2, 20, 0xFFFFFF);
      this.add.rectangle(gameWidth - shoulderWidth - 20, y, 2, 20, 0xFFFFFF);
    }
    
    this.laneWidth = laneWidth;
    this.roadStart = roadStart;
  }

  createBackgroundElements() {
    const gameWidth = this.sys.game.config.width;
    const gameHeight = this.sys.game.config.height;
    const shoulderWidth = gameWidth * 0.15;
    
    // –î–µ—Ä–µ–≤—å—è –Ω–∞ –æ–±–æ—á–∏–Ω–∞—Ö
    for (let i = 0; i < 12; i++) {
      const side = i % 2;
      const x = side === 0 ? shoulderWidth / 2 : gameWidth - shoulderWidth / 2;
      const y = (i / 2) * (gameHeight / 6) + 50;
      
      this.add.rectangle(x, y, 15, 50, 0x8B4513);
      this.add.circle(x, y - 25, 30, 0x006400);
      this.add.ellipse(x + 10, y + 25, 40, 15, 0x000000, 0.3);
    }
    
    // –ó–¥–∞–Ω–∏—è –Ω–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ
    for (let i = 0; i < 8; i++) {
      const side = i % 2;
      const x = side === 0 ? -30 : gameWidth + 30;
      const y = (i / 2) * (gameHeight / 4) + 100;
      const height = Phaser.Math.Between(80, 150);
      const width = Phaser.Math.Between(40, 80);
      
      this.add.rectangle(x, y - height/2, width, height, 0x696969);
      for (let j = 0; j < 3; j++) {
        for (let k = 0; k < Math.floor(height/30); k++) {
          if (Phaser.Math.Between(0, 100) < 60) {
            this.add.rectangle(x - width/3 + j * width/3, y - height/2 + k * 25, 8, 8, 0xFFFF00, 0.8);
          }
        }
      }
    }
  }

  createScoreEffect(x, y, text) {
    const scoreText = this.add.text(x, y, text, {
      font: 'bold 20px Arial',
      fill: text.includes('üíé') ? '#00FFFF' : '#00ff00',
      stroke: '#000',
      strokeThickness: 2
    }).setOrigin(0.5);
    
    this.tweens.add({
      targets: scoreText,
      y: y - 50,
      alpha: 0,
      duration: 1000,
      ease: 'Power2',
      onComplete: () => scoreText.destroy()
    });
  }

  updateDiamondsDisplay() {
    this.diamondsText.setText(`üíé ${GameData.getDiamonds()}`);
    this.diamondsText.setStyle({
      font: 'bold 20px Commissioner',
      fill: '#FFEE00',
      stroke: '#222222',
      strokeThickness: 1
    });
  }

  update(time, delta) {
    if (this.gameOverFlag) return;

    if (time > this.nextSpeedUp) {
      this.speed += 25;
      this.nextSpeedUp = time + 5000;
    }

    this.score += delta * 0.01;
    this.scoreText.setText('–°–ß–ï–¢: ' + Math.floor(this.score));

    // –°–ø–∞–≤–Ω –∞–ª–º–∞–∑–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    if (time - this.lastDiamondSpawnTime > 30000) {
      const randomLane = Phaser.Math.Between(0, 2);
      this.spawnObject('extrabonus', randomLane);
      this.lastDiamondSpawnTime = time;
    }

    if (time - this.lastObstacleSpawnTime > 800) {
      const lanes = Phaser.Utils.Array.Shuffle([0, 1, 2]);
      let placedObstacles = 0;

      for (let i = 0; i < lanes.length; i++) {
        const lane = lanes[i];
        if (placedObstacles < 2 && Phaser.Math.Between(0, 1000) < 300) {
          this.spawnObject('obstacle', lane);
          placedObstacles++;
        } else if (Phaser.Math.Between(0, 1000) < 60) { // –£–º–µ–Ω—å—à–µ–Ω–æ —Å 120 –¥–æ 60
          this.spawnObject('bonus', lane);
        }
      }
      this.lastObstacleSpawnTime = time;
    }

    this.obstacles.children.iterate(child => child.y += this.speed * delta / 1000);
    this.bonuses.children.iterate(child => child.y += this.speed * delta / 1000);
    this.extraBonuses.children.iterate(child => child.y += this.speed * delta / 1000);
    
    this.playerShadow.x = this.player.x;
    this.playerShadow.y = this.player.y + 30;
  }

  spawnObject(type, lane) {
    const x = this.roadStart + lane * this.laneWidth + this.laneWidth / 2;
    const y = -60;
    
    if (type === 'extrabonus') {
      // –°–æ–∑–¥–∞–µ–º –∞–ª–º–∞–∑
      const diamond = this.extraBonuses.create(x, y, 'bonus');
      diamond.setDisplaySize(this.sys.game.config.width * 0.1, this.sys.game.config.height * 0.05);
      diamond.setTint(0x00FFFF); // –ì–æ–ª—É–±–æ–π —Ü–≤–µ—Ç –¥–ª—è –∞–ª–º–∞–∑–æ–≤
      diamond.setImmovable(true);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ä—Ü–∞–Ω–∏–µ
      this.tweens.add({
        targets: diamond,
        alpha: 0.3,
        duration: 500,
        yoyo: true,
        repeat: -1
      });
    } else {
      const group = (type === 'bonus') ? this.bonuses : this.obstacles;
      const sprite = group.create(x, y, type);
      sprite.setDisplaySize(this.sys.game.config.width * 0.14, this.sys.game.config.height * 0.07);
      sprite.setImmovable(true);
    }
  }

  changeLane(dir) {
    if (this.gameOverFlag) return;
    this.player.lane = Phaser.Math.Clamp(this.player.lane + dir, 0, this.laneCount - 1);
    this.player.x = this.roadStart + this.player.lane * this.laneWidth + this.laneWidth / 2;
  }

  handleGameOver() {
    if (this.gameOverFlag) return;
    this.gameOverFlag = true;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—á–µ—Ç
    GameData.saveScore(this.score);

    this.physics.pause();
    this.player.setTint(0xff0000);

    // –≠–∫—Ä–∞–Ω –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã
    const overlay = this.add.rectangle(this.sys.game.config.width / 2, this.sys.game.config.height / 2, 400, 300, 0x000000, 0.9);
    overlay.setStrokeStyle(3, 0xFFFFFF);
    
    this.add.text(this.sys.game.config.width / 2, this.sys.game.config.height / 2 - 80, '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê', { 
      font: 'bold 28px Arial', 
      fill: '#ff4444',
      stroke: '#000',
      strokeThickness: 2
    }).setOrigin(0.5);
    
    this.add.text(this.sys.game.config.width / 2, this.sys.game.config.height / 2 - 40, '–ò—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç: ' + Math.floor(this.score), { 
      font: 'bold 20px Arial', 
      fill: '#fff',
      stroke: '#000',
      strokeThickness: 1
    }).setOrigin(0.5);
    
    const restartButton = this.add.text(this.sys.game.config.width / 2, this.sys.game.config.height / 2 + 10, '–ù–ê–ß–ê–¢–¨ –ó–ê–ù–û–í–û', { 
      font: 'bold 22px Arial', 
      fill: '#00ff00', 
      backgroundColor: '#000',
      stroke: '#fff',
      strokeThickness: 1
    })
      .setOrigin(0.5)
      .setPadding(15, 10)
      .setInteractive()
      .on('pointerdown', () => {
        this.scene.restart();
      })
      .on('pointerover', () => {
        restartButton.setScale(1.1);
        restartButton.setFill('#44ff44');
      })
      .on('pointerout', () => {
        restartButton.setScale(1);
        restartButton.setFill('#00ff00');
      });

    const menuButton = this.add.text(this.sys.game.config.width / 2, this.sys.game.config.height / 2 + 60, '–ú–ï–ù–Æ', { 
      font: 'bold 22px Arial', 
      fill: '#ffaa00', 
      backgroundColor: '#000',
      stroke: '#fff',
      strokeThickness: 1
    })
      .setOrigin(0.5)
      .setPadding(15, 10)
      .setInteractive()
      .on('pointerdown', () => {
        this.scene.start('MenuScene');
      })
      .on('pointerover', () => {
        menuButton.setScale(1.1);
        menuButton.setFill('#ffcc44');
      })
      .on('pointerout', () => {
        menuButton.setScale(1);
        menuButton.setFill('#ffaa00');
      });
  }

  handleSwipe(endX, endY) {
    const deltaX = endX - this.touchStartX;
    const deltaY = endY - this.touchStartY;
    
    const minSwipeDistance = 30;
    
    if (Math.abs(deltaX) > minSwipeDistance) {
      if (Math.abs(deltaX) > Math.abs(deltaY)) {
        if (deltaX > 0) {
          this.changeLane(1);
        } else {
          this.changeLane(-1);
        }
      }
    } else {
      const screenWidth = this.sys.game.config.width;
      if (endX < screenWidth / 2) {
        this.changeLane(-1);
      } else {
        this.changeLane(1);
      }
    }
  }
}

const config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  physics: { default: 'arcade' },
  scene: [MenuScene, ShopScene, PromotionsScene, LeaderboardScene, MainScene]
};

const game = new Phaser.Game(config);

window.addEventListener('resize', () => {
  game.scale.resize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
